---
title: '\ '
output: blogdown::html_page
params:
  seed: 1
---

```{r, echo = F, message = F, warning = F}
if(!require(pacman)) install.packages("pacman")
pacman::p_load(
  # necessary for all quizzes runs
  tidyverse, 
  here,
  knitr,
  googledrive,
  rio,
  # specific to this quiz             
  cowplot, 
  xfun,
  #required for it to run:
  blogdown,
  shiny,
  readxl,
  janitor)

knitr::opts_chunk$set(warning = F, message = F)

source(here("global/functions/misc_functions.R"))

# Setup for uploading images and datasets
if (!drive_has_token()) drive_auth(email = "trainingteam@thegraphnetwork.org")
options(gargle_oauth_email = "trainingteam@thegraphnetwork.org")
knitr::opts_knit$set(upload.fun = gdrive_upload) # pulled by knitr to upload image

# Set seed
set.seed(params$seed)
```

In this data quiz, we will be performing operations on two datasets. They will be introduced one by one with their respective questions.

------------------------------------------------------------------------

First, you will analyze a dataset sample of a population-based cohort in China: clinical information about adults at baseline was used to predict whether they developed diabetes after some years of followup.

```{r echo = F}
diab_china_dat_raw <- 
  read_excel(here("ch04_data_wrangling/data/diabetes_china_chen.xlsx")) %>%
  select(-`BMI(kg/m2)`) %>% 
  # Sample data
  slice_sample(n = 200) %>%
  clean_names()
```

```{r echo = F, results = "asis"}
upload_and_link(diab_china_dat_raw, filename = "diab_china_dat_raw", format =  "csv")
```

Here are the top 6 rows of `diab_china_dat_raw` after import:

```{r}
head(diab_china_dat_raw)
```

------------------------------------------------------------------------

Second, you will be working with an interesting survey data. HIV-positive people were surveyed about socio-demographics and their feelings of depression, with the eye to understanding the causes of depression.

```{r echo = F}
hiv_depression_india_raw <- 
  read_excel(here("ch04_data_wrangling/data/hiv_depression_india_rabeya.xlsx")) %>%
  # Sample data
  slice_sample(n = 200) %>%
  clean_names()
```

```{r echo = F, results = "asis"}
upload_and_link(hiv_depression_india_raw, filename = "hiv_depression_india_raw", format =  "csv")
```

Here are the top 6 rows of `hiv_depression_india_raw` after import:

```{r}
head(hiv_depression_india_raw)
```

------------------------------------------------------------------------

# Part A: case_when Warm Up !

**1. Using the diabetes dataset, create a new variable to look at the age of participants differently: make an `age_group` variable.**

Lowerbounds are excluded from the intervals, upperbounds are included in the intervals.

```{r eval = F}
diab_china_dat <- 
  diab_china_dat_raw %>%
  mutate(age_group = {case_when}(
    {age_y<=20} ~ "0-20",
    age_y{>}20 {&} {age_y<=40} ~ "21-40",
    age_y > {40} {&} {age_y<=60} ~ "41-60",
    {age_y>60} {&} {age_y<=80} ~ "61-80",
    {age_y>80} ~ "81+"
  )) 
    
```

**2. Using the diabetes dataset and the previous question, how many patients are in the 21-40 age group? Answer: {`r nrow(diab_china_dat_raw %>% mutate(age_group = case_when(age_y<=20  ~ "0-20", age_y>20 & age_y<=40 ~ "21-40", age_y > 40 & age_y<=60 ~ "41-60", age_y>60 & age_y<= 80 ~ "61-80", age_y>80 ~ "81+"))%>%filter(age_group=="21-40"))`}**

**3.In the HIV dataset, perform the same manipulation, create a new variable representing different age groups.**

Lowerbounds are included from the intervals, upperbounds are excluded in the intervals.

```{r eval = F}
hiv_depression_india <- 
  hiv_depression_india_raw %>%
  mutate(age_group = {case_when}(
    {age<18} ~ "0-17",
    age{>=}18 {&} {age<30} ~ "18-29",
    age{>=40} {&} {age<60} ~ "30-59",
    {age>=60} {&} {age<90} ~ "60-89",
    {age>=90} ~ "90+"
  )) 
```

**4. Using the HIV dataset and the previous question, how many respondents are in the 30-59 age group? Answer: {`r nrow(hiv_depression_india_raw%>%mutate(age_group = case_when(age<18 ~ "0-17",age >= 18 | age < 30 ~ "18-29",age >= 40 | age < 60 ~ "30-59", age >= 60 | age < 90 ~ "60-89",age >= 90  ~ "90+"))%>%filter(age_group=="30-59"))`}**

**5. In the HIV dataset, replace the marital status numerical, categorical variable by its corresponding names.**

(1 corresponds to married, 2 corresponds to unmarried, and 3 corresponds to divorced_separated)

```{r eval = F}
hiv_depression_india <- 
  hiv_depression_india_raw %>%
  mutate(marital_status = case_when(marital_status{==1~"married"},
                                    {marital_status==2}~"unmarried",
                                    marital_status==3{~"divorced_separated"},
                                    is.na{(marital_status)~NA_character_})) 
```

**6. In the HIV dataset and using the previous question, which percentage of the respondents is unmarried? Answer: {`r hiv_depression_india_raw %>% mutate(marital_status = case_when(marital_status==1~"married",marital_status==2~"unmarried",marital_status==3~"divorced_separated",is.na(marital_status)~NA_character_)) %>% tabyl(marital_status) %>% filter(marital_status=="unmarried") %>% select(percent) %>% pull() *100`}**

------------------------------------------------------------------------

# Part B: TRUE default argument

**7. In the HIV dataset, using the TRUE default argument, create a new variable for guilt levels based on the following classification of guilty feelings:**

-   Low guilt corresponds to "I don;t feel particularly guilty" (encoded as 0).
-   Intermediate guilt corresponds to "I feel guilty over many thing I have done or should have done" (encoded as 1).
-   Strong guilt corresponds to "I feel guilty most of the time" (encoded as 2) OR "I feel guilt all of the time" (encoded as 3).

```{r eval = F}
hiv_depression_india <- 
  hiv_depression_india_raw %>%
  mutate(guilty_feelings = case_when({guilty_feelings==0} ~ "low_guilt",
                                     guilty_feelings==1 {~"intermediate_guilt"},
                                     {is.na(guilty_feelings)} ~ NA_character_,
                                     TRUE~{"strong_guilt"})) 

```

**8. In the HIV dataset and based on the previous question, what percentage of the respondents had strong guilt feelings? Answer: {`r hiv_depression_india_raw %>% mutate(guilty_feelings = case_when(guilty_feelings==0 ~ "low_guilt",guilty_feelings==1 ~"intermediate_guilt",is.na(guilty_feelings) ~ NA_character_,TRUE~"strong_guilt")) %>% tabyl(guilty_feelings) %>% filter(guilty_feelings=="strong_guilt") %>%select(percent)%>%pull()*100`}**

**9. In the HIV dataset, using the TRUE default argument, create a new variable for irritability levels based on the following classification of irritability feelings:**

-   Low irritability corresponds to "I am not more irritable than usual" (encoded as 0) OR "I am more irritable than usual" (encoded as 1).
-   Strong irritability corresponds to "I am much more irritable than usual" (encoded as 2) OR "I am irritable all the time" (encoded as 3).

```{r eval = F}
hiv_depression_india <- 
  hiv_depression_india_raw %>%
  mutate(irritability = case_when({irritability==0} {|} {irritability==1} ~ "low_irritability",
                                     is.na(irritability) ~ {NA_character_},
                                     TRUE~{"strong_irritability"})) 
```

**10. In the HIV dataset and based on the previous question, what percentage of the respondents had strong guilt feelings? Answer: {`r hiv_depression_india_raw %>%mutate(irritability = case_when((irritability==0 | irritability==1) ~ "low_irritability",is.na(irritability) ~ NA_character_,TRUE~"strong_irritability")) %>% tabyl(irritability) %>% filter(irritability=="strong_irritability") %>% select(percent) %>% pull()*100`}**

------------------------------------------------------------------------

# Part C: Default values of a variable

**11. In the diabetes dataset, recode the NAs into 0 in the diabetes diagnosed during followup column.**

It is important to note that we want to keep the 1 (encoding Yes) as is in the column.

```{r eval = F}
diab_china_dat <- 
  diab_china_dat_raw %>%
  mutate(diabetes_diagnosed_during_followup_1_yes = 
           case_when({is.na(diabetes_diagnosed_during_followup_1_yes)} ~ 0,
                     TRUE ~ {diabetes_diagnosed_during_followup_1_yes} ))

```

------------------------------------------------------------------------

# Part D: Multiple conditions on a single variable

**12. In the diabetes dataset, using `mutate()`, create a new variable reflecting smoking history (recategorizing people as smokers or non smokers).**

The default value should be "unknown" and all NAs should be set to "unknown" as well.

```{r eval = F}
diab_china_dat <- 
  diab_china_dat_raw %>%
  mutate(smoking_history = case_when(
    smoking_status_1_current_smoker_2_ever_smoker_3_never_smoker{==1} {|} smoking_status_1_current_smoker_2_ever_smoker_3_never_smoker{==2} ~ "smoker",
    smoking_status_1_current_smoker_2_ever_smoker_3_never_smoker== 3 ~ {"non_smoker"},
    {is.na(smoking_status_1_current_smoker_2_ever_smoker_3_never_smoker)} ~ "unknown",
    {TRUE~} "unknown"
  ))
```

**13. In the diabetes dataset and using the previous question, how many have a smoking history? Answer: {`r nrow(diab_china_dat_raw %>% mutate(smoking_history = case_when(smoking_status_1_current_smoker_2_ever_smoker_3_never_smoker== 1 |smoking_status_1_current_smoker_2_ever_smoker_3_never_smoker== 2 ~ "smoker",smoking_status_1_current_smoker_2_ever_smoker_3_never_smoker== 3 ~ "non_smoker", is.na(smoking_status_1_current_smoker_2_ever_smoker_3_never_smoker) ~ "unknown",TRUE ~ "unknown")) %>%  filter(smoking_history=="smoker"))`}**

**14. In the diabetes dataset, categorize FPG of the final visit into 3 levels**

Normal levels are defined as strictly lower as 5.5 mmol/L. Abnormal is defined as FPG levels between 5.5 and 7 mmol/L. Alarming is defined as equal or above 7 mmol/L.

```{r eval = F}
diab_china_dat <- 
  diab_china_dat_raw %>%
  mutate(fpg_levels = 
           case_when({fpg_of_final_visit_mmol_l<5.5} ~ "normal",
                     {fpg_of_final_visit_mmol_l>=5.5} {&} {fpg_of_final_visit_mmol_l<7} ~ "abnormal",
                     {fpg_of_final_visit_mmol_l>= 7} ~ "alarming"))

```

**15. Using the diabetes dataset and the previous question, how many respondents have an abnormal level of FPG at the final visit? Answer: {`r diab_china_dat_raw %>% mutate(fpg_levels = case_when(fpg_of_final_visit_mmol_l< 5.5 ~ "normal",fpg_of_final_visit_mmol_l>= 5.5 & fpg_of_final_visit_mmol_l< 7 ~ "abnormal",fpg_of_final_visit_mmol_l>= 7 ~ "alarming" )) %>% tabyl(fpg_levels) %>% filter(fpg_levels=="abnormal")%>%select(percent)%>%pull()*100`}**

------------------------------------------------------------------------

# Part E: Multiple conditions on multiple variables

**16. Using the diabetes dataset, create a risk factor column using the drinking history and the smoking history columns**

-   The risk factors are low when the person is nor was a drinker nor a smoker. 
-   The risk factors are medium if the person was either a smoker or a drinker. 
-   The risk factors are high if the person is currently either a smoker or a drinker.

Please note: order of conditions matters here ! Make sure you understand why. Handling of NA values is also important.

```{r eval = F}
diab_china_dat <- 
  diab_china_dat_raw %>%
  mutate(risk_factors = 
           case_when(
             drinking_status_1_current_drinker_2_ever_drinker_3_never_drinker{==3} {&} smoking_status_1_current_smoker_2_ever_smoker_3_never_smoker{==3} ~ "low",
             drinking_status_1_current_drinker_2_ever_drinker_3_never_drinker{==3} {&} {is.na}(smoking_status_1_current_smoker_2_ever_smoker_3_never_smoker) ~ "low",
             {is.na}(drinking_status_1_current_drinker_2_ever_drinker_3_never_drinker) {&} smoking_status_1_current_smoker_2_ever_smoker_3_never_smoker{==3} ~ "low",
             drinking_status_1_current_drinker_2_ever_drinker_3_never_drinker{==1} {|} smoking_status_1_current_smoker_2_ever_smoker_3_never_smoker{==1} ~ "high",
             drinking_status_1_current_drinker_2_ever_drinker_3_never_drinker{==2} {|} smoking_status_1_current_smoker_2_ever_smoker_3_never_smoker{==2} ~ "medium",
             {is.na}(drinking_status_1_current_drinker_2_ever_drinker_3_never_drinker) {&} {is.na}(smoking_status_1_current_smoker_2_ever_smoker_3_never_smoker) ~ {NA_character_}
             )) 

```

**17. Using the diabetes dataset, categorize risk levels based on FPG measures and family history.**

People who have FPG lower than 5.5 mmol/L are at low risk. But if they have family history they are at medium risk. People who have FPG between 5.5 and 7 mmol/L are at medium risk. But if they have family history, they are at high risk. Anyone who has FPG higher than 7 mmol/L is at high risk.

```{r eval = F}
diab_china_dat <- 
  diab_china_dat_raw %>%
  mutate(fpg_levels = 
           case_when(fpg_of_final_visit_mmol_l<5.5 ~ "low_risk",
                     fpg_of_final_visit_mmol_l<5.5 {&} family_histroy_of_diabetes_1_yes_0_no{==1} ~ "medium_risk",
                     fpg_of_final_visit_mmol_l>=5.5 {&} fpg_of_final_visit_mmol_l<7 ~ "medium_risk",
                     fpg_of_final_visit_mmol_l>=5.5 {&} fpg_of_final_visit_mmol_l<7 {&} family_histroy_of_diabetes_1_yes_0_no{==1} ~ "high_risk"
                     fpg_of_final_visit_mmol_l>=7 ~ "high_risk"))
```

------------------------------------------------------------------------

# Part F: if_else

**18. In the HIV dataset, use if_else to rewrite the receiving HIV treatment column into a Yes-No encoding.**

(1 encodes yes and 2 encodes no.)

```{r eval = F}
hiv_depression_india <- 
  hiv_depression_india_raw %>%
  mutate(receiving_hiv_treatment= if_else(receiving_hiv_treatment==1, {"yes"},{"no"}))
```

**19. In the HIV dataset, replace the religion numerical, categorical variable by its corresponding names.**

(1 corresponds to islam, 2 corresponds to hindu, and 3 corresponds to Others.)

```{r eval = F}
hiv_depression_india <- 
  hiv_depression_india_raw %>%
  mutate(religion = if_else(religion==1, {"islam"},{"hindu"}))
```

**3. In the HIV dataset and based on the previous question, what percentage of the respondents is islamic? (Hint: use tabyl! Your answer should be a percentage.) Answer: {`r hiv_depression_india_raw%>%mutate(religion = if_else(religion==1, "islam","hindu"))%>% janitor::tabyl(religion)%>%filter(religion=="islam") %>%select(percent) %>%pull()*100`}**

------------------------------------------------------------------------
