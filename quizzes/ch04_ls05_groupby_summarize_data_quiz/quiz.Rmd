---
title: '\ '
output: blogdown::html_page
params:
  seed: 1
---

```{r, echo = F, message = F, warning = F}
if(!require(pacman)) install.packages("pacman")
pacman::p_load(
  # necessary for all quizzes runs
  tidyverse, 
  here,
  knitr,
  googledrive,
  rio,
  # specific to this quiz             
  cowplot, 
  xfun,
  #required for it to run:
  blogdown,
  shiny,
  readxl)

knitr::opts_chunk$set(warning = F, message = F)

source(here("global/functions/misc_functions.R"))

# Setup for uploading images and datasets
if (!drive_has_token()) drive_auth(email = "trainingteam@thegraphnetwork.org")
options(gargle_oauth_email = "trainingteam@thegraphnetwork.org")
knitr::opts_knit$set(upload.fun = gdrive_upload) # pulled by knitr to upload image

# Set seed
set.seed(params$seed)
```

The overall goal of this quiz will be test your knowledge of group_by and summarize.  

------------------------------------------------------------------------

First, you will analyze a dataset sample of a population-based cohort in China: clinical information about adults at baseline was used to predict whether they developed diabetes after some years of followup.

```{r echo = F}
diab_china_dat_raw <- 
  read_excel(here("ch04_data_wrangling/data/diabetes_china_chen.xlsx")) %>%
    # Sample data
  slice_sample(n = 200) %>%
  select(-`BMI(kg/m2)`) %>% 
  mutate(`smoking status(1,current smoker;2, ever smoker;3,never smoker)` = as.factor(`smoking status(1,current smoker;2, ever smoker;3,never smoker)`),
         `drinking status(1,current drinker;2, ever drinker;3,never drinker)` = as.factor(`drinking status(1,current drinker;2, ever drinker;3,never drinker)`)) %>%
  clean_names()
```

```{r echo = F, results = "asis"}
upload_and_link(diab_china_dat_raw, filename = "diab_china_dat_raw", format =  "csv")
```

Here are the top 6 rows of `diab_china_dat_raw` after import:

```{r}
head(diab_china_dat_raw)
```

------------------------------------------------------------------------

Second, you will be working with an interesting survey data. HIV-positive people were surveyed about socio-demographics and their feelings of depression, with the eye to understanding the causes of depression.

```{r echo = F}
hiv_depression_india_raw <- 
  read_excel(here("ch04_data_wrangling/data/hiv_depression_india_rabeya.xlsx")) %>%
  # Sample data
  slice_sample(n = 200) %>%
  mutate(Religion = if_else(Religion==1, "islam", "hindu"),
         Sex = case_when(Sex==1 ~"male", 
                         Sex==2 ~"female",
                         Sex==3 ~ "transgender"),
         Marital_Status = case_when(
           Marital_Status ==0 ~ "married",
           Marital_Status==1 ~ "unmarried",
           Marital_Status==2 ~ "divorced or separated"),
         Suicidal_Thoughts_or_Wishes = case_when(
           Suicidal_Thoughts_or_Wishes==0 ~ "none",
           Suicidal_Thoughts_or_Wishes==1 ~ "some",
           Suicidal_Thoughts_or_Wishes==2 ~ "often",
           Suicidal_Thoughts_or_Wishes==3 ~ "omnipresent"),
         Sadness = case_when(
           Sadness ==0 ~ "none",
           Sadness==1 ~ "some",
           Sadness==2 ~ "often",
           Sadness==3 ~ "unbearable"),
         Pesimism = case_when(
           Pesimism ==0 ~ "none",
           Pesimism==1 ~ "discouraged",
           Pesimism==2 ~ "hopeless",
           Pesimism==3 ~ "hopeless and doomed")
         ) %>%
  select(Age, Sex, Religion, Marital_Status, Suicidal_Thoughts_or_Wishes, Sadness, Pesimism) %>%
  clean_names()
```

```{r echo = F, results = "asis"}
upload_and_link(hiv_depression_india_raw, filename = "hiv_depression_india_raw", format =  "csv")
```

Here are the top 6 rows of `hiv_depression_india_raw` after import:

```{r}
head(hiv_depression_india_raw)
```

------------------------------------------------------------------------

# Part A : Summarize 

**1 Using the diabetes dataset, write up code to get the average of cholesterol over the entire study.**

```{r eval = F}
mean_cholesterol_result <- 
  diab_china_dat_raw %>%
  {summarize}(mean_cholesterol = {mean}(cholesterol_mmol_l, na.rm={TRUE}))

```

**2 Using the diabetes dataset, what is the value of the mean cholesterol level (give the resulting number with one decimal)?  Answer: {`r round(diab_china_dat_raw %>% summarize(mean_cholesterol = mean(cholesterol_mmol_l, na.rm=TRUE))%>%pull(), 1)`}**

**3 Using the diabetes dataset, following a similar method, give the median trigyceride level over all patients. (give the resulting number with one decimal) Answer:  {`r  round(diab_china_dat_raw %>% summarize(median_triglyceride = median(triglyceride_mmol_l, na.rm=TRUE)) %>% pull(), 1)`}**

**4 Using the diabetes dataset, give the median age of this cohort. Answer: {`r diab_china_dat_raw %>% summarize(median_age = median(age_y, na.rm=TRUE)) %>% pull()`}**

**5 Using the HIV dataset and similar to the previous question, give the median age of this cohort. Answer: {`r hiv_depression_india_raw %>% summarize(median_age = median(age, na.rm=TRUE)) %>% pull()`}**

------------------------------------------------------------------------

# Part B : Group by 

**6 Using the diabetes dataset, by gender, calculate the average HDL-c level (mmol/L).** 

```{r eval = F}
average_HDL_by_gender <- 
  diab_china_dat_raw %>%
  {group_by}(gender_1_male_2_female) %>%
  summarize(average_HDL = {mean}(hdl_c_mmol_l, {na.rm=TRUE}))

```

**7 Using the diabetes dataset and the previous question, what is the average HDL-c level (mmol/L) for men (round to 2 decimals)? {`r round(diab_china_dat_raw %>%group_by(gender_1_male_2_female) %>%summarize(average_HDL = mean(hdl_c_mmol_l, na.rm=TRUE)) %>%filter(gender_1_male_2_female==1) %>%pull(),2)`}**

**8 Using the HIV dataset, calculate the mean age of the respondents, grouping by sadness feelings.**

```{r eval = F}
hiv_depression_india <- 
  hiv_depression_india_raw %>%
  group_by({sadness}) %>%
  summarize(average_age = {mean(age, na.rm=TRUE)})
```

------------------------------------------------------------------------

# Part C : Nested Group by

**9 Using the diabetes dataset, group by the smoking status and the drinking status, to calculate the median LDL level (mmol/L).**

```{r eval = F}
diab_china_dat <-
  diab_china_dat_raw %>%
  group_by(smoking_status_1_current_smoker_2_ever_smoker_3_never_smoker,
           drinking_status_1_current_drinker_2_ever_drinker_3_never_drinker,
           {.drop = FALSE}) %>%
  summarize(median_LDL = {median(ldl_mmol_l, na.rm=TRUE)}) 

```

**10 Using the HIV dataset, group by sex, pessimism feelings, and suicidal thoughts, to calculate the mean age of the respondents.**

```{r eval = F}
hiv_depression_india <- 
  hiv_depression_india_raw %>%
  mutate(pesimism = as.factor({pesimism}),
         sex = {as.factor(sex)}) %>%
  group_by({pesimism, sex, .drop=FALSE}) %>%
  summarize(average_age = {mean(age, na.rm=TRUE)})
```
------------------------------------------------------------------------

# Part D: Summarize with a condition

**11 Using the HIV dataset, group by sadness feelings and sex, then use summarize() with a condition to count the number of respondents under 30.**

```{r eval = F}
hiv_depression_india <- 
  hiv_depression_india_raw %>%
  mutate({sadness = as.factor(sadness)},
         {sex = as.factor(sex)}) %>%
  group_by({sadness, sex, .drop=FALSE}) %>%
  summarize(counts = {sum}({age<30}))

```

**12 Using the HIV dataset, group by sex, then use summarize() with a condition to count the number of respondents who have complete records for pesimism feelings.**

Hint: complete records means the pesimism variable is not NA. 

```{r eval = F}
hiv_depression_india <- 
  hiv_depression_india_raw %>%
  group_by(sex) %>%
  summarize(counts = sum(!is.na(pesimism)))
```

------------------------------------------------------------------------

# Part E : Count 

**13 Using the diabetes dataset, investigate how many people have family history, and how many do not.**

```{r eval = F}
counts_family_history <-  
  diab_china_dat_raw %>%
  {count}(family_histroy_of_diabetes_1_yes_0_no)
```

**14 Using the diabetes dataset and similar to the previous question, how many patients are women in this cohort? {`r diab_china_dat_raw %>% count(gender_1_male_2_female)%>%filter(gender_1_male_2_female==2)%>%pull()`}**

**15 Using the HIV dataset, investigate by gender and marital status, how many people have suicidal thoughts.**

```{r eval = F}
counts_suicidal_thoughts <-  
  hiv_depression_india_raw %>%
  mutate(suicidal_thoughts_or_wishes = {as.factor}(suicidal_thoughts_or_wishes),
         sex = {as.factor(sex)},
         marital_status = {as.factor(marital_status)}) %>%
  {count}(suicidal_thoughts_or_wishes, sex, marital_status, {.drop=FALSE})
```






